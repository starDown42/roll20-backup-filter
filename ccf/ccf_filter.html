<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>CCF í…ìŠ¤íŠ¸ ì¶”ì¶œ</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="../style.css" rel="stylesheet">
	<script src="https://unpkg.com/prettier@3.0.0/standalone.js"></script>
	<script src="https://unpkg.com/prettier@3.0.0/plugins/html.js"></script>
	<style>
		#title::after {
			content: 'ì—…ë¡œë“œ íŒŒì¼ì˜ ê²½ìš°, [https://sukenell.github.io/cclog_custom/] ì‚¬ì´íŠ¸ì—ì„œ ê°€ê³µí•œ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.';
			font-size: 1rem;
			display: inline-block;
			margin-left: 10px;
			color: #777;
		}
	</style>
</head>

<body class="container py-4">
	<h2 class="mb-3 text-center"><a class="hometitle" href="../index.html">ORPG ë°±ì—… ì„œí¬íŠ¸</a></h2>
	<hr class="my-4">
	<h3 class="mb-3">CCF í…ìŠ¤íŠ¸ ì¶”ì¶œ</h3>
	<hr class="my-4">
	<div>
		<h4 class="mb-3" id="title">HTML íŒŒì¼ ì—…ë¡œë“œ</h4>
		<input type="file" id="fileInput" accept=".html" class="form-control mb-3">
		<button onclick="extractDialogue()" class="btn btn-success">í…ìŠ¤íŠ¸ ì¶”ì¶œ</button>
	</div>
	<hr class="my-4 mb-3">
	<h4 class="mb-3">í…ìŠ¤íŠ¸ ì¶”ì¶œ</h4>
	<div class="d-flex align-items-stretch">
		<textarea id="output" class="form-control" readonly="true" data-type="hidden" style="height: 100px;"></textarea>
		<button id="btn_outputCopy" class="btn btn-secondary ms-2">ğŸ“‹</button>
	</div>

	<div class="my-4 mb-3">
		<h4 class="mb-3">ì €ë„ë³„ ëŒ€ì‚¬ ì¶”ì¶œ</h4>
		<div class="d-flex">
			<textarea id="journalOutput" class="form-control textarea-box"></textarea>
			<div class="ms-2 w-25">
				<select id="journalSelect" class="form-select"><option value="0">-</option></select>
				<button id="btn_journalTxtCopy" class="btn btn-secondary mt-2 w-100">ğŸ“‹</button>
			</div>
		</div>
	</div>

	<script>
		var messages = {};

		const fileInput = document.getElementById('fileInput');

		const outputArea = document.getElementById('output');
		const btnOutputCopy = document.getElementById('btn_outputCopy');

		const journalOutputArea = document.getElementById('journalOutput');
		const btn_journalTxtCopy = document.getElementById('btn_journalTxtCopy');
		const journalSelect = document.getElementById('journalSelect');
		
		document.addEventListener("DOMContentLoaded", function () {
			btnOutputCopy.onclick = () => {
				navigator.clipboard.writeText(outputArea.value);
				alert(`ì „ì²´ ì¶œë ¥ ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
			};

			btn_journalTxtCopy.onclick = () => {
				if(journalSelect.value != 0) {
					navigator.clipboard.writeText(journalOutputArea.value);
					alert(`ì €ë„ë³„ ëŒ€ì‚¬ ì¶œë ¥ ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
				} else {
					alert("ì €ë„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")
					return;
				}
			};

			// SelectBox ë³€ê²½ ì´ë²¤íŠ¸
			journalSelect.onchange = () => {
				let selectedKey = journalSelect.value;
				if (messages[selectedKey]) {
					journalOutputArea.value = messages[selectedKey].join("\n\n");
				} else {
					journalOutputArea.value = "";
				}
			};
		});

		const prettierConfig = {
			arrowParens: "always",
			bracketSameLine: false,
			objectWrap: "preserve",
			bracketSpacing: true,
			semi: true,
			experimentalOperatorPosition: "end",
			experimentalTernaries: false,
			singleQuote: true,
			jsxSingleQuote: false,
			quoteProps: "as-needed",
			trailingComma: "all",
			singleAttributePerLine: false,
			htmlWhitespaceSensitivity: "css",
			vueIndentScriptAndStyle: false,
			proseWrap: "preserve",
			insertPragma: false,
			printWidth: 9999,
			requirePragma: false,
			tabWidth: 4,
			useTabs: true,
			embeddedLanguageFormatting: "off",
		};


		async function extractDialogue() {
			if (!fileInput.files.length) return alert('HTML íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');

			const reader = new FileReader();
			reader.onload = async function (event) { // âœ… async ì¶”ê°€
				outputArea.value = "";
				journalOutputArea.value = "";


				const parser = new DOMParser();
				const oriDoc = parser.parseFromString(event.target.result, 'text/html');

				// ğŸ”¹ Prettierë¥¼ ì´ìš©í•œ í¬ë§·íŒ…
				const formattedHtml = await prettier.format(event.target.result, { // âœ… await ì •ìƒ ì ìš©
					parser: "html",
					plugins: [prettierPlugins.html],
					...prettierConfig, // âœ… ì»¤ìŠ¤í…€ ì„¤ì • ì ìš©
				});

				// ğŸ”¹ ë‹¤ì‹œ HTMLë¡œ ë³€í™˜ (ì¤‘ìš”!)
				const doc = parser.parseFromString(formattedHtml, 'text/html');

				let output = '';
				messages = {};

				doc.querySelectorAll('.gap').forEach(gap => {
					let spans = gap.querySelectorAll('p span');

					// ì´ë¦„ë¦„
					let nameParts = [];
					// ğŸ”¹ ì²« ë²ˆì§¸ ìš”ì†Œê°€ ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ "[ì²« ë²ˆì§¸ ìš”ì†Œ]"
					if (spans[0].textContent.trim()) {
						nameParts.push(`[${spans[0].textContent.trim()}]`);
					}
					// ğŸ”¹ ë‘ ë²ˆì§¸ ìš”ì†Œë¶€í„° ë§ˆì§€ë§‰ì„ ì œì™¸í•œ ìš”ì†Œë“¤ì„ ëª¨ë‘ í•©ì¹¨
					for (let i = 1; i < spans.length - 1; i++) {
						let text = spans[i].textContent.trim();
						if (text) nameParts.push(text);
					}
					const name = nameParts.join(' '); // ìµœì¢… ì´ë¦„ êµ¬ì„±

					// ëŒ€ì‚¬
					let textElem = spans[spans.length - 1]; // ë§ˆì§€ë§‰ span
					const text = textElem.textContent.trim();

					output += `${name}::\t${text}\n`;

					// message ì— ì €ì¥
					if (messages[name]) {
						messages[name].push(text);
					}
					else {
						messages[name] = [text];
					}
				});

				// ì¶”ì¶œ ê²°ê³¼ output ì¶œë ¥
				outputArea.value = output;

				// ì¼ë°˜ ëŒ€ì‚¬ë§Œ ì¶œë ¥í•  ìˆ˜ ìˆë„ë¡ ìºë¦­í„°ëª…ì„ select boxì— ê°’ ì¶”ê°€ê°€
				 // ê¸°ì¡´ ì˜µì…˜ ì œê±° í›„ ê¸°ë³¸ê°’ ì¶”ê°€
				 journalSelect.innerHTML = '<option value="0">ì„ íƒ</option>';

				// messagesì˜ key ê°’ì„ selectboxì— ì¶”ê°€
				Object.keys(messages).forEach(key => {
					let option = document.createElement("option");
					option.value = key;
					option.textContent = key;
					journalSelect.appendChild(option);
				});

			};
			reader.readAsText(fileInput.files[0]);
		}

	</script>
</body>

</html>