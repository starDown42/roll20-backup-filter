<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roll20 필터링</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const conditions = [
                { name: "숨김 메시지 삭제", deleteType: "hidden" },
                { name: "[PRO] 사담 API 삭제", deleteType: "etc" },
                { name: "전체 삭제", deleteType: "all" }
            ];

            const inputBox = document.getElementById("htmlInput");
            const orignCobyButton = document.getElementById("orignCobyButton");
            orignCobyButton.onclick = () => {
                navigator.clipboard.writeText(inputBox.value);
                alert(`입력한 원본 HTML 코드가 클립보드에 복사되었습니다.`);
            };

            const resultsContainer = document.getElementById("results");
            const filterButton = document.getElementById("filterButton");            
             
            function createResultFields() {
                conditions.forEach(cond => {
                    let wrapper = document.createElement("div");
                    wrapper.classList.add("mb-3");
                    
                    let title = document.createElement("h4");
                    title.classList.add("mb-3");
                    title.textContent = cond.name;
                    
                    let innerWrapper = document.createElement("div");
                    innerWrapper.classList.add("d-flex", "align-items-stretch");
                    
                    let textarea = document.createElement("textarea");
                    textarea.classList.add("form-control");
                    textarea.setAttribute("readonly", true);
                    textarea.style.height = "100px";
                    textarea.dataset.type = cond.deleteType;

                    let copyButton = document.createElement("button");
                    copyButton.innerHTML = "📋";
                    copyButton.classList.add("btn", "btn-secondary", "ms-2");
                    copyButton.onclick = () => {
                        navigator.clipboard.writeText(textarea.value);
                        alert(`${cond.name} 결과가 클립보드에 복사되었습니다.`);
                    };
                    
                    innerWrapper.appendChild(textarea);
                    innerWrapper.appendChild(copyButton);
                    wrapper.appendChild(title);
                    wrapper.appendChild(innerWrapper);
                    resultsContainer.appendChild(wrapper);
                });
            }

            function filterHtml() {
                let htmlContent = inputBox.value;
                if (!htmlContent.trim()) return alert("HTML 코드를 입력하세요.");
                
                let parser = new DOMParser();
                let doc = parser.parseFromString(htmlContent, "text/html");

                conditions.forEach(cond => {
                    let deleteTargets = [];
                    if (cond.deleteType === "hidden") {
                        deleteTargets.push(...doc.querySelectorAll("div.message.hidden-message"));
                    } else if (cond.deleteType === "etc") {
                        doc.querySelectorAll("div.message span[style='color: #aaaaaa']").forEach(span => {
                            let parentMessage = span.closest("div.message");
                            if (parentMessage) deleteTargets.push(parentMessage);
                        });
                    } else if (cond.deleteType === "all") {
                        deleteTargets.push(...doc.querySelectorAll("div.message.hidden-message"));
                        doc.querySelectorAll("div.message span[style='color: #aaaaaa']").forEach(span => {
                            let parentMessage = span.closest("div.message");
                            if (parentMessage) deleteTargets.push(parentMessage);
                        });
                    }
                    
                    deleteTargets = deleteTargets.filter(el => {
                        if (!el.querySelector("div.avatar")) {
                            el.remove();
                            return false;
                        }
                        return true;
                    });
                    
                    deleteTargets.forEach(A => {
                        let B = A.nextElementSibling;
                        if (!B || !B.classList.contains("message")) return;
                        
                        if (A.querySelector("div.avatar")) {
                            if (B.querySelector("div.avatar")) {
                                A.remove();
                            } else {
                                ["div.spacer", "div.avatar", "div.tstamp", "div.by"].forEach(cls => {
                                    A.querySelectorAll(cls).forEach(child => B.prepend(child.cloneNode(true)));
                                });
                                A.remove();
                            }
                        } else {
                            A.remove();
                        }
                    });
                    
                    let resultTextarea = resultsContainer.querySelector(`textarea[data-type="${cond.deleteType}"]`);
                    resultTextarea.value = doc.body.innerHTML;
                });
            }
            
            filterButton.addEventListener("click", filterHtml);
            createResultFields();
        });
    </script>
</head>
<body class="container py-4">
    <h2 class="mb-3">Roll20 필터링</h2>
    <hr class="my-4"> <!-- 구분선 추가 -->
    <div>
        <h4 class="mb-3">원본 HTML 코드 입력</h4>
        
        <textarea id="htmlInput" class="form-control mb-3" rows="6" placeholder="&lt;div class= &quot;textchatcontainer &quot; id= &quot;textchat &quot;&gt; 전체를 입력해주세요."></textarea>
        <div class="d-flex justify-content-end align-items-center">
            <button id="orignCobyButton" class="btn btn-secondary" >📋</button>
            <button id="filterButton" class="btn btn-primary ms-2">필터링 시작</button>
        </div>
    </div>
    <hr class="my-4"> <!-- 구분선 추가 -->
    <div id="results">

    </div>
</body>
</html>
