<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roll20 í•„í„°ë§</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const conditions = [
                { name: "ìˆ¨ê¹€ ë©”ì‹œì§€ ì‚­ì œ", deleteType: "hidden" },
                { name: "[PRO] ì‚¬ë‹´ API ì‚­ì œ", deleteType: "etc" },
                { name: "ì „ì²´ ì‚­ì œ", deleteType: "all" }
            ];

            const inputBox = document.getElementById("htmlInput");
            const resultsContainer = document.getElementById("results");
            const filterButton = document.getElementById("filterButton");
            const journalButton = document.getElementById("journalButton"); // ì €ë„ ì¶”ì¶œ ë²„íŠ¼ ì¶”ê°€

            function createResultFields() {
                conditions.forEach(cond => {
                    let wrapper = document.createElement("div");
                    wrapper.classList.add("mb-3");

                    let title = document.createElement("h4");
                    title.classList.add("mb-3");
                    title.textContent = cond.name;

                    let innerWrapper = document.createElement("div");
                    innerWrapper.classList.add("d-flex", "align-items-stretch");

                    let textarea = document.createElement("textarea");
                    textarea.classList.add("form-control");
                    textarea.setAttribute("readonly", true);
                    textarea.style.height = "100px";
                    textarea.dataset.type = cond.deleteType;

                    let copyButton = document.createElement("button");
                    copyButton.innerHTML = "ğŸ“‹";
                    copyButton.classList.add("btn", "btn-secondary", "ms-2");
                    copyButton.onclick = () => {
                        navigator.clipboard.writeText(textarea.value);
                        alert(`${cond.name} ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    };

                    innerWrapper.appendChild(textarea);
                    innerWrapper.appendChild(copyButton);
                    wrapper.appendChild(title);
                    wrapper.appendChild(innerWrapper);
                    resultsContainer.appendChild(wrapper);
                });

                // ì €ë„ í¬ë§· ê²°ê³¼ì°½ ì¶”ê°€
                let journalWrapper = document.createElement("div");
                journalWrapper.classList.add("mb-3");

                let journalTitle = document.createElement("h4");
                journalTitle.classList.add("mb-3");
                journalTitle.textContent = "ì €ë„ í¬ë§· ë³€í™˜ ê²°ê³¼";

                let journalInnerWrapper = document.createElement("div");
                journalInnerWrapper.classList.add("d-flex", "align-items-stretch");

                let journalTextarea = document.createElement("textarea");
                journalTextarea.classList.add("form-control");
                journalTextarea.setAttribute("readonly", true);
                journalTextarea.style.height = "150px";
                journalTextarea.id = "journalResult";

                let journalCopyButton = document.createElement("button");
                journalCopyButton.innerHTML = "ğŸ“‹";
                journalCopyButton.classList.add("btn", "btn-secondary", "ms-2");
                journalCopyButton.onclick = () => {
                    navigator.clipboard.writeText(journalTextarea.value);
                    alert("ì €ë„ í¬ë§· ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                };

                journalInnerWrapper.appendChild(journalTextarea);
                journalInnerWrapper.appendChild(journalCopyButton);
                journalWrapper.appendChild(journalTitle);
                journalWrapper.appendChild(journalInnerWrapper);
                resultsContainer.appendChild(journalWrapper);
            }

            function filterHtml() {
                let htmlContent = inputBox.value;
                if (!htmlContent.trim()) return alert("HTML ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

                let parser = new DOMParser();
                let doc = parser.parseFromString(htmlContent, "text/html");

                conditions.forEach(cond => {
                    let deleteTargets = [];
                    if (cond.deleteType === "hidden") {
                        deleteTargets.push(...doc.querySelectorAll("div.message.hidden-message"));
                    } else if (cond.deleteType === "etc") {
                        doc.querySelectorAll("div.message span[style='color: #aaaaaa']").forEach(span => {
                            let parentMessage = span.closest("div.message");
                            if (parentMessage) deleteTargets.push(parentMessage);
                        });
                    } else if (cond.deleteType === "all") {
                        deleteTargets.push(...doc.querySelectorAll("div.message.hidden-message"));
                        doc.querySelectorAll("div.message span[style='color: #aaaaaa']").forEach(span => {
                            let parentMessage = span.closest("div.message");
                            if (parentMessage) deleteTargets.push(parentMessage);
                        });
                    }

                    deleteTargets = deleteTargets.filter(el => {
                        if (!el.querySelector("div.avatar")) {
                            el.remove();
                            return false;
                        }
                        return true;
                    });

                    deleteTargets.forEach(A => {
                        let B = A.nextElementSibling;
                        if (!B || !B.classList.contains("message")) return;

                        if (A.querySelector("div.avatar")) {
                            if (B.querySelector("div.avatar")) {
                                A.remove();
                            } else {
                                ["div.spacer", "div.avatar", "div.tstamp", "div.by"].forEach(cls => {
                                    A.querySelectorAll(cls).forEach(child => B.prepend(child.cloneNode(true)));
                                });
                                A.remove();
                            }
                        } else {
                            A.remove();
                        }
                    });

                    let resultTextarea = resultsContainer.querySelector(`textarea[data-type="${cond.deleteType}"]`);
                    resultTextarea.value = doc.body.innerHTML;
                });

                alert("í•„í„°ë§ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
            }

            function extractJournalFormat() {
                let htmlContent = inputBox.value;
                if (!htmlContent.trim()) return alert("HTML ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                
                let parser = new DOMParser();
                let doc = parser.parseFromString(htmlContent, "text/html");
                
                let output = [];
                let descBuffer = '';
                let emoteBuffer = ''; // emoteë¥¼ ìœ„í•œ ë²„í¼ ì¶”ê°€
                
                doc.querySelectorAll('.textchatcontainer .content .message').forEach(node => {
                    if (node.nodeType === Node.ELEMENT_NODE && node.classList.contains('message')) {
                        // .desc í´ë˜ìŠ¤ ì²˜ë¦¬
                        if (node.classList.contains('desc')) {
                            descBuffer += (descBuffer ? ' ' : '') + node.innerText.trim(); // .desc ë‚´ìš© ë³‘í•©

                                // .emoteê°€ ìˆìœ¼ë©´ ë¨¼ì € ì¶œë ¥í•˜ê³ , ëŒ€ì‚¬ë¥¼ ì¶œë ¥
                                if (emoteBuffer) {
                                    output.push(`\n${emoteBuffer}`); // .emoteëŠ” ë§¨ ì•ì— \n ì¶”ê°€
                                    emoteBuffer = ''; // emoteBuffer ì´ˆê¸°í™”
                                }
                        } 
                        // .emote í´ë˜ìŠ¤ ì²˜ë¦¬
                        else if (node.classList.contains('emote')) {
                            emoteBuffer += (emoteBuffer ? ' ' : '') + node.innerText.trim(); // .emote ë‚´ìš© ë³‘í•©

                            // .descê°€ ìˆìœ¼ë©´ ë¨¼ì € ì¶œë ¥í•˜ê³ , ëŒ€ì‚¬ë¥¼ ì¶œë ¥
                            if (descBuffer) {
                                output.push(`\n${descBuffer}`); // .descëŠ” ë§¨ ì•ì— \n ì¶”ê°€
                                descBuffer = ''; // descBuffer ì´ˆê¸°í™”
                            }
                        }
                        else {
                            // ëŒ€ì‚¬ ë¶€ë¶„
                            const authorNode = node.querySelector('.by');
                            const author = authorNode ? authorNode.textContent.trim() : '';
                            
                            const textNode = Array.from(node.childNodes)
                                .filter(n => n.nodeType === Node.TEXT_NODE)  // í…ìŠ¤íŠ¸ ë…¸ë“œë¥¼ í•„í„°ë§
                                .map(n => n.nodeValue.trim())  // í…ìŠ¤íŠ¸ ê°’ë§Œ ê°€ì ¸ì˜¤ê¸°
                                .filter(n => n !== '');  // ë¹ˆ í…ìŠ¤íŠ¸ëŠ” ì œì™¸
                            
                            // ì²« ë²ˆì§¸ í…ìŠ¤íŠ¸ëŠ” ëŒ€ì‚¬ê°€ ì•„ë‹ˆë¯€ë¡œ ë‘ ë²ˆì§¸ í…ìŠ¤íŠ¸ë¶€í„° ëŒ€ì‚¬ë¡œ ì‚¬ìš©
                            const text = textNode.length > 1 ? textNode.slice(1).join(' ') : textNode[0] || '';
                            
                            // .descê°€ ìˆìœ¼ë©´ ë¨¼ì € ì¶œë ¥í•˜ê³ , ëŒ€ì‚¬ë¥¼ ì¶œë ¥
                            if (descBuffer) {
                                output.push(`\n${descBuffer}`); // .descëŠ” ë§¨ ì•ì— \n ì¶”ê°€
                                descBuffer = ''; // descBuffer ì´ˆê¸°í™”
                            }
                            
                            // .emoteê°€ ìˆìœ¼ë©´ ë¨¼ì € ì¶œë ¥í•˜ê³ , ëŒ€ì‚¬ë¥¼ ì¶œë ¥
                            if (emoteBuffer) {
                                output.push(`\n${emoteBuffer}`); // .emoteëŠ” ë§¨ ì•ì— \n ì¶”ê°€
                                emoteBuffer = ''; // emoteBuffer ì´ˆê¸°í™”
                            }

                            // ì‘ì„±ìê°€ ìˆì„ ê²½ìš°
                            if (author) {
                                output.push(`\n${author}:[ì €ë„ëª…]\t${text}`);  // ì‘ì„±ìê°€ ìˆì„ ê²½ìš° ë§¨ ì•ì— \n ì¶”ê°€
                            } else {
                                // ì‘ì„±ìê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ í…ìŠ¤íŠ¸ë§Œ ì¶œë ¥
                                output.push(text);
                            }
                        }
                    } else if (node.nodeType === Node.TEXT_NODE && node.nodeValue.trim() !== '') {
                        // í…ìŠ¤íŠ¸ ë…¸ë“œê°€ ìˆë‹¤ë©´ ê·¸ ìì²´ë¥¼ ì¶œë ¥
                        if (descBuffer) {
                            output.push(`\n${descBuffer}`);
                            descBuffer = ''; // ì´ˆê¸°í™”
                        }
                        if (emoteBuffer) {
                            output.push(`\n${emoteBuffer}`);
                            emoteBuffer = ''; // ì´ˆê¸°í™”
                        }
                        output.push(node.nodeValue.trim());
                    }
                });

                // .desc ë©”ì‹œì§€ê°€ ë§ˆì§€ë§‰ì— ë‚¨ì•„ ìˆë‹¤ë©´ ì¶œë ¥
                if (descBuffer) {
                    output.push(`\n${descBuffer}`);
                }
                
                // .emote ë©”ì‹œì§€ê°€ ë§ˆì§€ë§‰ì— ë‚¨ì•„ ìˆë‹¤ë©´ ì¶œë ¥
                if (emoteBuffer) {
                    output.push(`\n${emoteBuffer}`);
                }

                document.getElementById("journalResult").value = output.join("\n");
                alert("í…ìŠ¤íŠ¸ ì¶”ì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
            }



            filterButton.addEventListener("click", filterHtml);
            journalButton.addEventListener("click", extractJournalFormat);
            createResultFields();
        });
    </script>
</head>
<body class="container py-4">
    <h2 class="mb-3">Roll20 í•„í„°ë§</h2>
    <hr class="my-4">
    <div>
        <h4 class="mb-3">ì›ë³¸ HTML ì½”ë“œ ì…ë ¥</h4>
        <textarea id="htmlInput" class="form-control mb-3" rows="6" placeholder="&lt;div class= &quot;textchatcontainer&quot; id= &quot;textchat&quot;&gt; ì „ì²´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
        <div class="d-flex justify-content-end align-items-center">
            <button id="orignCobyButton" class="btn btn-secondary">ğŸ“‹</button>
            <button id="filterButton" class="btn btn-primary ms-2">í•„í„°ë§ ì‹œì‘</button>
            <button id="journalButton" class="btn btn-success ms-2">í…ìŠ¤íŠ¸ ì¶”ì¶œ</button>
        </div>
    </div>
    <hr class="my-4">
    <div id="results"></div>
</body>
</html>
